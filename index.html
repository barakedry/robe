<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Robe by hiddentao</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Robe</h1>
        <p>MongoDB ODM for Node.js using ES6 generators. Supports schema validation, raw querying, cursors, etc.</p>
        <p class="view"><a href="https://github.com/hiddentao/robe">View the Project on GitHub <small>hiddentao/robe</small></a></p>
        <ul>
          <li><a href="https://github.com/hiddentao/robe/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/hiddentao/robe/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/hiddentao/robe">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>
<a id="robe" class="anchor" href="#robe" aria-hidden="true"><span class="octicon octicon-link"></span></a>Robe</h1>

<p><strong>NOTE: For now this is just the README.md that comes with Robe. More detailed and better-looking documentation is coming very soon!</strong></p>

<p><strong>Robe</strong> wraps around <a href="https://github.com/Automattic/monk">monk</a> to provide a 
simple yet effective ODM library for MongoDB. </p>

<p>Features:</p>

<ul>
<li>Work with ODM-style documents or raw Mongo data - the choice is yours</li>
<li>Add before and after hooks for inserts, updates and removals</li>
<li>Cursor mode (for streaming results)</li>
<li>Schema validation (<a href="https://github.com/hiddentao/simple-mongo-schema">simple-mongo-schema</a>).</li>
<li>Replica sets supported</li>
<li><a href="https://hiddentao.github.io/robe">and more...</a></li>
</ul>

<h2>
<a id="examples" class="anchor" href="#examples" aria-hidden="true"><span class="octicon octicon-link"></span></a>Examples</h2>

<p>Detailed documentation is available at <a href="https://hiddentao.github.io/robe">https://hiddentao.github.io/robe</a>.</p>

<p><strong>The basics</strong></p>

<div class="highlight highlight-js"><pre><span class="pl-s1"><span class="pl-pds">"</span>use strict<span class="pl-pds">"</span></span>;

<span class="pl-s">var</span> robe <span class="pl-k">=</span> <span class="pl-s3">require</span>(<span class="pl-s1"><span class="pl-pds">'</span>robe<span class="pl-pds">'</span></span>);

<span class="pl-c">// connect to db</span>
<span class="pl-s">var</span> db <span class="pl-k">=</span> <span class="pl-k">yield</span> robe.connect(<span class="pl-s1"><span class="pl-pds">'</span>127.0.0.1<span class="pl-pds">'</span></span>);

<span class="pl-c">// get a collection</span>
<span class="pl-s">var</span> collection <span class="pl-k">=</span> db.collection(<span class="pl-s1"><span class="pl-pds">'</span>test<span class="pl-pds">'</span></span>);

<span class="pl-c">// insert a record</span>
<span class="pl-k">yield</span> collection.insert({
  name<span class="pl-k">:</span> <span class="pl-s1"><span class="pl-pds">'</span>jim<span class="pl-pds">'</span></span>,
  age<span class="pl-k">:</span> <span class="pl-c1">23</span>
});

<span class="pl-c">// find it</span>
<span class="pl-s">var</span> item <span class="pl-k">=</span> <span class="pl-k">yield</span> collection.findOne({
  name<span class="pl-k">:</span> <span class="pl-s1"><span class="pl-pds">'</span>jim<span class="pl-pds">'</span></span>
});

<span class="pl-en">console</span><span class="pl-s3">.log</span>(item <span class="pl-k">instanceof</span> robe.Document); <span class="pl-c">// true</span>
<span class="pl-en">console</span><span class="pl-s3">.log</span>(<span class="pl-s3">Object</span>.keys(item)); <span class="pl-c">// _id, name, age</span>

<span class="pl-c">// update</span>
item.age <span class="pl-k">=</span> <span class="pl-c1">54</span>;
<span class="pl-k">yield</span> item.save();    <span class="pl-c">// internally calls collection.update(...)</span>

<span class="pl-c">// remove</span>
<span class="pl-k">yield</span> item.<span class="pl-s3">remove</span>();  <span class="pl-c">// internally calls collection.remove(...)</span></pre></div>

<p><strong>Raw querying mode</strong></p>

<p>In this mode we won't make use of <code>robe.Document</code> and will instead deal 
directly with Mongo data objects.</p>

<div class="highlight highlight-js"><pre><span class="pl-c">// insert a record</span>
<span class="pl-k">yield</span> collection.insert({
  name<span class="pl-k">:</span> <span class="pl-s1"><span class="pl-pds">'</span>jim<span class="pl-pds">'</span></span>,
  age<span class="pl-k">:</span> <span class="pl-c1">23</span>
});

<span class="pl-c">// find it</span>
<span class="pl-s">var</span> item <span class="pl-k">=</span> <span class="pl-k">yield</span> collection.findOne({
  name<span class="pl-k">:</span> <span class="pl-s1"><span class="pl-pds">'</span>jim<span class="pl-pds">'</span></span>
}, {
  raw<span class="pl-k">:</span> <span class="pl-c1">true</span> <span class="pl-c">// return the raw mongo object</span>
});

<span class="pl-en">console</span><span class="pl-s3">.log</span>(item <span class="pl-k">instanceof</span> robe.Document); <span class="pl-c">// false</span>
<span class="pl-en">console</span><span class="pl-s3">.log</span>(<span class="pl-s3">Object</span>.keys(item)); <span class="pl-c">// _id, name, age</span>

<span class="pl-c">// update</span>
<span class="pl-k">yield</span> collection.update({
  _id<span class="pl-k">:</span> item._id
}, {
  $set<span class="pl-k">:</span> {
    age<span class="pl-k">:</span> <span class="pl-c1">54</span>
  }
});

<span class="pl-c">// remove</span>
<span class="pl-k">yield</span> collection.<span class="pl-s3">remove</span>({
  _id<span class="pl-k">:</span> item._id
});</pre></div>

<p>You can also enable <code>raw</code> querying at the collection level:</p>

<div class="highlight highlight-js"><pre><span class="pl-s">var</span> collection <span class="pl-k">=</span> db.collection(<span class="pl-s1"><span class="pl-pds">'</span>test<span class="pl-pds">'</span></span>, {
  raw<span class="pl-k">:</span> <span class="pl-c1">true</span>
});

<span class="pl-k">yield</span> collection.findOne({
  name<span class="pl-k">:</span> <span class="pl-s1"><span class="pl-pds">'</span>john<span class="pl-pds">'</span></span>
}, {
  raw<span class="pl-k">:</span> <span class="pl-c1">false</span>  <span class="pl-c">// override the collection-level setting</span>
});</pre></div>

<p><strong>Hooks</strong></p>

<p>You can add multiple <code>before</code> and <code>after</code> hooks for insertions, updates and 
removals. Hooks get triggered even when calling the <code>save()</code> and <code>remove()</code> 
methods on a <code>robe.Document</code> instance.</p>

<div class="highlight highlight-js"><pre>collection.before(<span class="pl-s1"><span class="pl-pds">'</span>remove<span class="pl-pds">'</span></span>, <span class="pl-st">function*</span>(<span class="pl-vpf">search</span>, <span class="pl-vpf">next</span>) {
  <span class="pl-en">console</span><span class="pl-s3">.log</span>(<span class="pl-s1"><span class="pl-pds">'</span>Before hook<span class="pl-pds">'</span></span>);

  search.age <span class="pl-k">=</span> <span class="pl-c1">54</span>;  

  <span class="pl-en">console</span><span class="pl-s3">.log</span>(JSON.stringify(search));

  <span class="pl-k">yield</span> next;
});

collection.after(<span class="pl-s1"><span class="pl-pds">'</span>remove<span class="pl-pds">'</span></span>, <span class="pl-st">function*</span>(<span class="pl-vpf">search</span>, <span class="pl-vpf">result</span>, <span class="pl-vpf">next</span>) {
  <span class="pl-en">console</span><span class="pl-s3">.log</span>(<span class="pl-s1"><span class="pl-pds">'</span>After hook: <span class="pl-pds">'</span></span> <span class="pl-k">+</span> result);

  <span class="pl-k">yield</span> next;
});

<span class="pl-c">// remove</span>
<span class="pl-k">yield</span> collection.<span class="pl-s3">remove</span>({
  name<span class="pl-k">:</span> <span class="pl-s1"><span class="pl-pds">'</span>john<span class="pl-pds">'</span></span>
});

<span class="pl-c">/*</span>
<span class="pl-c">Ouptut:</span>
<span class="pl-c"></span>
<span class="pl-c"> Before hook</span>
<span class="pl-c"> { name: 'john', age: 54 }</span>
<span class="pl-c"> After hook: 1</span>
<span class="pl-c">*/</span></pre></div>

<p><strong>Schema validation</strong></p>

<p>Schema definitions are as supported by <a href="https://github.com/hiddentao/simple-mongo-schema">simple-mongo-schema</a>. 
Inserts and updates trigger schema validation checks. Any keys not specified in the schema 
get ignored during validation, i.e. a schema can be a partial definition of a document.</p>

<div class="highlight highlight-js"><pre><span class="pl-c">// get a collection</span>
<span class="pl-s">var</span> collection <span class="pl-k">=</span> db.collection(<span class="pl-s1"><span class="pl-pds">'</span>test<span class="pl-pds">'</span></span>, {
  schema<span class="pl-k">:</span> {
    name<span class="pl-k">:</span> {
      type<span class="pl-k">:</span> <span class="pl-s3">String</span>
    },
    isMarried<span class="pl-k">:</span> {
      type<span class="pl-k">:</span> <span class="pl-s3">Boolean</span>
    },
    numCars<span class="pl-k">:</span> {
      type<span class="pl-k">:</span> <span class="pl-s3">Number</span>
    },
  }  
});

<span class="pl-c">// insert a record</span>
<span class="pl-k">try</span> {
  <span class="pl-k">yield</span> collection.insert({
    name<span class="pl-k">:</span> <span class="pl-s1"><span class="pl-pds">'</span>jim<span class="pl-pds">'</span></span>,
    hasKids<span class="pl-k">:</span> <span class="pl-c1">true</span>,
    isMarried<span class="pl-k">:</span> <span class="pl-s1"><span class="pl-pds">'</span>yes<span class="pl-pds">'</span></span>,
    numCars<span class="pl-k">:</span> <span class="pl-s1"><span class="pl-pds">'</span>20<span class="pl-pds">'</span></span>
  });
} <span class="pl-k">catch</span> (err) {

  <span class="pl-en">console</span><span class="pl-s3">.log</span>(err);

  <span class="pl-c">/*</span>
<span class="pl-c">    Error: Validation failed</span>
<span class="pl-c">  */</span>


  <span class="pl-en">console</span><span class="pl-s3">.log</span>(err.failures); 

  <span class="pl-c">/*</span>
<span class="pl-c">    [</span>
<span class="pl-c">      "/isMarried: must be true or false",</span>
<span class="pl-c">      "/numCars: must be a number",</span>
<span class="pl-c">    ]  </span>
<span class="pl-c">  */</span>
}</pre></div>

<h2>
<a id="building" class="anchor" href="#building" aria-hidden="true"><span class="octicon octicon-link"></span></a>Building</h2>

<p>To run the tests:</p>

<pre><code>$ npm install -g gulp
$ npm install
$ npm test
</code></pre>

<h2>
<a id="contributing" class="anchor" href="#contributing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Contributing</h2>

<p>Contributions are welcome! Please see <a href="https://github.com/hiddentao/robe/blob/master/CONTRIBUTING.md">CONTRIBUTING.md</a>.</p>

<h2>
<a id="inspiration-and-thanks" class="anchor" href="#inspiration-and-thanks" aria-hidden="true"><span class="octicon octicon-link"></span></a>Inspiration and thanks</h2>

<ul>
<li><a href="http://mongoosejs.com">mongoose</a></li>
<li><a href="http://mongorito.com/">mongorito</a></li>
<li><a href="docs.meteor.com/#/full/collections">Meteor</a></li>
</ul>

<h2>
<a id="license" class="anchor" href="#license" aria-hidden="true"><span class="octicon octicon-link"></span></a>License</h2>

<p>MIT - see <a href="https://github.com/hiddentao/robe/blob/master/LICENSE.md">LICENSE.md</a></p>
      </section>
    </div>
    <footer>
      <p>Project maintained by <a href="https://github.com/hiddentao">hiddentao</a></p>
      <p>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></p>
    </footer>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>